<!DOCTYPE HTML>

<html>

<head>
	<title>Voyage</title>
	<meta charset="utf-8" />
	<meta name="miniprojet" content="width=device-width, initial-scale=1" />
	<link rel="icon" href="./assets/favicon.ico" type="image/gif" sizes="16x16">
	<link rel="stylesheet" href="./assets/css/style.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="assets/js/main.js"></script>
	<script src="./js/scripts.js" defer async></script>
</head>


<!-- Modal -->

<div class="wrapper modal" id="myModal">

</div>

<!-- Navbar -->
<div id="topnav"></div>

<body>

	<!-- Grid -->
	<div id="title">
		<h1>Nos meilleures destinations waouh</h1>
	</div>

	<main id="grid-container" class="grid">
		<template id="grid-template">
			<article>
				<img id="grid-image" onclick="assignURLFunction()" src={{image}} alt={{image-alt}}>
				<div class="grid-text">
					<h3 id="grid-place">{{place}}</h3>
					<p id="grid-description">{{description}}</p>
					<p id="grid-price" style="margin-left: 80%;"><b>{{price}}{{currency}}</b></p>
					<a class="btn grid-btn" href={{url}}>Voir en détails</a>
					<div id="temp">{{temp}}</div>
					<div id="tag-template">{{tags}}</div>
				</div>
			</article>
		</template>
	</main>

	<!-- Contact Form -->



	<div id="backToTopDiv"></div>
	<button onclick="topFunction()" class="btn" id="backToTopBtn" title="Go to top"><i
			class="fa fa-arrow-up"></i></button>

</body>

<!-- Footer -->
<footer id="footer"></footer>

<script>//let template = document.querySelector("#listeVoyage");
	let grid_template = document.querySelector("#grid-template");

	//récupération des données du fichier JSON
	var xhttp = [];
	var tempTab = [];
	var idcity;

	fetch("./json/data.json")
		.then(function (resp) {
			resp.json().then(function (data) {
				for (const d in data.destinations) {

					
					cityId = data.destinations[d].idCity;					
					xhttp[d] = new XMLHttpRequest();
					xhttp[d].onreadystatechange = function () {
						if (this.readyState == 4 && this.status == 200) {
							var obj = JSON.parse(this.responseText);
							tempTab[d] = obj.main.temp;
							console.log(data.destinations[d].place);
							console.log(tempTab.length);
							if (tempTab.length == data.destinations.length && testTempTab()) {
								for (i = 0; i < data.destinations.length; i++) {
									let clone = document.importNode(grid_template.content, true);      // clone template

									newContent = clone.firstElementChild.innerHTML
										.replace(/{{image}}/g, data.destinations[i].image)		// replace key by value from data (json)
										.replace(/{{place}}/g, data.destinations[i].place)				// et {{name}} par
										.replace(/{{price}}/g, data.destinations[i].price)
										.replace(/{{description}}/g, data.destinations[i].description)
										.replace(/{{currency}}/g, "$")
										.replace(/{{url}}/g, "/destination.html?id=" + data.destinations[i].id)
										.replace(/{{temp}}/g, Math.round(tempTab[i]) + "°")
										.replace(/{{tags}}/g, data.destinations[i].tags.map((a) => { return '<span class="tag">' + a + '</span>'; }).reduce((a, b, idx) => { return idx == 0 ? a : a + b; }));
									//d.tags tableau tags
									//Map sert à 'mapper' prendre indiv chaque elemdu tab et appliquer une fonction
									//Reduce() permet de transformerle tab en un seul élément (concatène mes chaînes de caractères) sinon concatène a + b
									//Permet au final de transformer le tableau en une seule chaîne de caractères.

									// Comment remplacer un élément avec une liste de valeurs du json



									clone.firstElementChild.innerHTML = newContent;
									document.getElementById("grid-container").appendChild(clone);
								}
							}
						}
					}
					xhttp[d].open("GET", `http://api.openweathermap.org/data/2.5/weather?id=${cityId}&units=metric&appid=b8e89339dec32ca1b99bece160747eb5`, true);
					xhttp[d].send();
					console.log(data.destinations[d].image);
				}
				
			})
		})
	function testTempTab() {
		for (const v of tempTab) {
			if (typeof v === 'undefined') {
				return false;
			}
		}
		return true;
	}

</script>

</html>